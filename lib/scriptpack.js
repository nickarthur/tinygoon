(function() { "use strict"; function f() {
goo.AxisAlignedCamControlScript=function(e,t,n){function o(){function t(t,i){i.axis=new e(e.UNIT_Z),i.upAxis=new e(e.UNIT_Y),o(t,i,t.view),i.currentView=t.view,i.lookAtPoint=new e(e.ZERO),i.distance=t.distance,i.smoothness=Math.pow(n.clamp(t.smoothness,0,1),.3),i.axisAlignedDirty=!0}function o(t,n,o){if(n.currentView!==o){switch(n.currentView=o,o){case"XY":n.axis.setVector(e.UNIT_Z),n.upAxis.setVector(e.UNIT_Y);break;case"ZY":n.axis.setVector(e.UNIT_X),n.upAxis.setVector(e.UNIT_Y)}n.axisAlignedDirty=!0}}function i(e,t){if(e.view!==t.currentView&&(t.axisAlignedDirty=!0),t.axisAlignedDirty){var n=t.entity,o=n.transformComponent.transform;o.translation.setVector(t.axis).scale(t.distance).addVector(t.lookAtPoint),o.lookAt(t.lookAtPoint,t.upAxis),n.transformComponent.setUpdated(),t.axisAlignedDirty=!1}}function r(){}return{setup:t,update:i,cleanup:r}}return o.externals={key:"AxisAlignedCamControlScript",name:"Axis-aligned Camera Control",description:"Aligns a camera along an axis, and enables switching between them.",parameters:[{key:"whenUsed",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0,type:"boolean"},{key:"distance",name:"Distance",type:"float",description:"Camera distance from lookat point",control:"slider","default":1,min:1,max:1e3},{key:"view",type:"string","default":"XY",control:"select",options:["XY","ZY"]}]},o}(goo.Vector3,goo.ScriptUtils,goo.MathUtils),goo.BasicControlScript=function(e,t){function n(n){n=n||{},this.domElement=void 0===n.domElement?null:n.domElement.domElement||n.domElement,this.name="BasicControlScript",this.movementSpeed=10,this.rollSpeed=2,this.movementSpeedMultiplier=1,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new e(0,0,0),this.rotationVector=new e(0,0,0),this.multiplier=new e(1,1,1),this.rotationMatrix=new t,this.tmpVec=new e,this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},this.keydown=function(e){if(!e.altKey){switch(e.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}},this.keyup=function(e){switch(e.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(e){this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e=e.touches&&1===e.touches.length?e.touches[0]:e,this.mouseDownX=e.pageX,this.mouseDownY=e.pageY,this.mouseStatus=1,document.addEventListener("mousemove",this.mousemove,!1),document.addEventListener("mouseup",this.mouseup,!1),document.addEventListener("touchmove",this.mousemove,!1),document.addEventListener("touchend",this.mouseup,!1)}.bind(this),this.mousemove=function(e){this.mouseStatus>0&&(e=e.touches&&1===e.touches.length?e.touches[0]:e,this.moveState.yawLeft=e.pageX-this.mouseDownX,this.moveState.pitchDown=e.pageY-this.mouseDownY,this.updateRotationVector(),this.mouseDownX=e.pageX,this.mouseDownY=e.pageY)}.bind(this),this.mouseup=function(e){this.mouseStatus&&(e.preventDefault(),this.mouseStatus=0,this.moveState.yawLeft=this.moveState.pitchDown=0,this.updateRotationVector(),document.removeEventListener("mousemove",this.mousemove),document.removeEventListener("mouseup",this.mouseup),document.removeEventListener("touchmove",this.mousemove),document.removeEventListener("touchend",this.mouseup))}.bind(this),this.updateMovementVector=function(){var e=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-e+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!==document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.domElement&&this.setupMouseControls(),this.updateMovementVector(),this.updateRotationVector()}return n.prototype.setupMouseControls=function(){this.domElement.setAttribute("tabindex",-1),this.domElement.addEventListener("mousedown",this.mousedown,!1),this.domElement.addEventListener("touchstart",this.mousedown,!1),this.domElement.addEventListener("keydown",this.keydown.bind(this),!1),this.domElement.addEventListener("keyup",this.keyup.bind(this),!1)},n.prototype.externals=function(){return[{variable:"movementSpeed",type:"number"},{variable:"rollSpeed",type:"number"}]},n.prototype.run=function(t,n,o){o&&!this.domElement&&o.domElement&&(this.domElement=o.domElement,this.setupMouseControls());var i=t.transformComponent,r=i.transform,a=t._world.tpf,s=a*this.movementSpeed*this.movementSpeedMultiplier,c=a*this.rollSpeed*this.movementSpeedMultiplier;(!this.moveVector.equals(e.ZERO)||!this.rotationVector.equals(e.ZERO)||this.mouseStatus>0)&&(r.translation.x+=this.moveVector.x*s,r.translation.y+=this.moveVector.y*s,r.translation.z+=this.moveVector.z*s,this.tmpVec.x+=-this.rotationVector.x*c*this.multiplier.x,this.tmpVec.y+=this.rotationVector.y*c*this.multiplier.y,this.tmpVec.z+=this.rotationVector.z*c*this.multiplier.z,r.rotation.fromAngles(this.tmpVec.x,this.tmpVec.y,this.tmpVec.z),this.mouseStatus>0&&(this.moveState.yawLeft=0,this.moveState.pitchDown=0,this.updateRotationVector()),i.setUpdated())},n}(goo.Vector3,goo.Matrix3x3),goo.ButtonScript=function(e,t,n,o,i){function r(){function e(e,n){n.button=["Any","Left","Middle","Right"].indexOf(e.button)-1,n.button<-1&&(n.button=-1),n.renderToPickHandler=function(){n.skipUpdateBuffer=!0},i.addListener("ButtonScript.renderToPick",n.renderToPickHandler,!1),n.mouseState={x:0,y:0,down:!1,downOnEntity:!1,overEntity:!1},n.listeners={mousedown:function(o){if(e.whenUsed){var i=r(o);(i===n.button||-1===n.button)&&(n.mouseState.down=!0,t(e,n,o),a(e,n,"mousedown"))}},mouseup:function(o){if(e.whenUsed){var i=r(o);(i===n.button||-1===n.button)&&(n.mouseState.down=!1,t(e,n,o),n.mouseState.downOnEntity&&a(e,n,"click"),a(e,n,"mouseup"))}},dblclick:function(o){if(e.whenUsed){var i=r(o);(i===n.button||-1===n.button)&&(n.mouseState.down=!1,t(e,n,o),a(e,n,"dblclick"))}},mousemove:function(o){e.whenUsed&&e.enableOnMouseMove&&(n.mouseState.down=!1,t(e,n,o),a(e,n,"mousemove"))},touchstart:function(t){if(e.whenUsed){n.mouseState.down=!0;var o=t.targetTouches,i=n.domElement.getBoundingClientRect();n.mouseState.x=o[0].pageX-i.left,n.mouseState.y=o[0].pageY-i.top,a(e,n,"touchstart")}},touchend:function(){e.whenUsed&&(n.mouseState.down=!1,a(e,n,"touchend"))}};for(var o in n.listeners)n.domElement.addEventListener(o,n.listeners[o])}function t(e,t,n){var o=t.domElement.getBoundingClientRect();t.mouseState.x=n.pageX-o.left,t.mouseState.y=n.pageY-o.top}function n(e,t){t.skipUpdateBuffer=!1}function o(e,t){for(var n in t.listeners)t.domElement.removeEventListener(n,t.listeners[n]);i.removeListener("ButtonScript.renderToPick",t.renderToPickHandler)}function r(e){var t=e.button;return 0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),t}function a(e,t,n){var o=t.entity._world.gooRunner,r=o.pickSync(t.mouseState.x,t.mouseState.y,t.skipUpdateBuffer);t.skipUpdateBuffer||i.emit("ButtonScript.renderToPick");var a=o.world.entityManager.getEntityByIndex(r.id);t.mouseState.downOnEntity=!1,a===t.entity&&(i.emit(e.channel+"."+n,{type:n,entity:a}),("mousedown"===n||"touchstart"===n)&&(t.mouseState.downOnEntity=!0),e.linkUrl&&"click"===n&&window.open(e.linkUrl,e.linkTarget)),"mousemove"===n&&!t.mouseState.overEntity&&a===t.entity&&i.emit(e.channel+".mouseover",{type:"mouseover",entity:a}),"mousemove"===n&&t.mouseState.overEntity&&a!==t.entity&&i.emit(e.channel+".mouseout",{type:"mouseout",entity:a}),t.mouseState.overEntity=a===t.entity}return{setup:e,update:n,cleanup:o}}return r.externals={key:"ButtonScript",name:"Button",description:"Enables an entity to be interacted with using click or touch.",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"button",name:"button",description:"Only interact with this mouse button.",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"linkUrl",name:"linkUrl",description:"URL to open when clicking the entity. Leave this field empty to disable.",type:"string","default":""},{key:"linkTarget",name:"linkTarget",description:"The window to open the link in.",type:"string","default":"_blank"},{key:"channel",name:"channel",description:"Event channel to emit to. Will emit channel.click, .mousedown, .mouseup, .mouseover, .mouseout, .dblclick, .touchstart, .touchend",type:"string","default":"button"},{key:"enableOnMouseMove",name:"enableOnMouseMove",description:"Enables .mousemove, .mouseover, and .mouseout events. For larger scenes, this might be worth turning off, for better performance.",type:"boolean","default":!0}]},r}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.SystemBus),goo.CannonPickScript=function(e,t,n,o,i){function r(){function t(e){var t=e[0].clientX,n=e[0].clientY,o=e[1].clientX,i=e[1].clientY,r=(t+o)/2,a=(n+i)/2;return[r,a]}function n(n,o){y=["Any","Left","Middle","Right"].indexOf(n.pickButton)-1,-1>y&&(y=-1),g=o.goingToLookAt,u=new e(e.UNIT_Y),m=new e(e.UNIT_X).invert(),p=new e,h=new e,f=new e;var i=o.world.gooRunner.renderer;w=i._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/i.svg.currentScale:1,x=o.world.getSystem("CannonSystem");var r=new a.Sphere(.1),s=o.jointBody=new a.RigidBody(0,r);s.collisionFilterGroup=2,s.collisionFilterMask=2,x.world.add(s),v={x:0,y:0,ox:0,oy:0,dx:0,dy:0,down:!1};var c=o.listeners={mousedown:function(e){if(!n.whenUsed||o.entity===o.activeCameraEntity){var t=e.button;0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),(t===y||-1===y)&&(v.down=!0,v.ox=v.x=e.clientX,v.oy=v.y=e.clientY)}},mouseup:function(e){var t=e.button;0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),(t===y||-1===y)&&(v.down=!1,v.dx=v.dy=0)},mousemove:function(e){(!n.whenUsed||o.entity===o.activeCameraEntity)&&v.down&&(v.x=e.clientX,v.y=e.clientY,o.dirty=!0)},mouseleave:function(){v.down=!1,v.ox=v.x,v.oy=v.y},touchstart:function(e){if(!n.whenUsed||o.entity===o.activeCameraEntity){if(v.down=2===e.targetTouches.length,!v.down)return;var i=t(e.targetTouches);v.ox=v.x=i[0],v.oy=v.y=i[1]}},touchmove:function(e){if(!n.whenUsed||o.entity===o.activeCameraEntity){if(!v.down)return;var i=t(e.targetTouches);v.x=i[0],v.y=i[1]}},touchend:function(){v.down=!1,v.ox=v.x,v.oy=v.y}};for(var l in c)o.domElement.addEventListener(l,c[l]);o.dirty=!0}function r(t,n){v.dx=v.x-v.ox,v.dy=v.y-v.oy,v.ox=v.x,v.oy=v.y;var i=o.mainCamera;if(i&&v.down&&!n.mouseConstraint){for(var r=[],s=n.world.by.system("CannonSystem").toArray(),u=0;u<s.length;u++){var m=s[u].cannonRigidbodyComponent.body;m&&m.shape instanceof a.Box&&m.motionstate===a.Body.DYNAMIC&&r.push(m)}var p=i.getPickRay(v.x,v.y,window.innerWidth,window.innerHeight),h=new a.Vec3(p.origin.x,p.origin.y,p.origin.z),f=new a.Vec3(p.direction.x,p.direction.y,p.direction.z),y=new a.Ray(h,f),g=y.intersectBodies(r);if(g.length){var m=g[0].body,w=g[0].point;c(t,n,w.x,w.y,w.z,m,p.direction.mul(-1))}}else if(i&&v.down&&n.mouseConstraint&&(0!==v.dx||0!==v.dy)){var i=o.mainCamera,p=i.getPickRay(v.x,v.y,window.innerWidth,window.innerHeight),x=new e;S.rayIntersect(p,x,!0),l(t,n,x)}else v.down||d(t,n)}function s(e,t){for(var n in t.listeners)t.domElement.removeEventListener(n,t.listeners[n])}function c(t,n,o,i,r,s,c){n.constrainedBody=s;var l=new a.Vec3(o,i,r).vsub(n.constrainedBody.position),d=n.constrainedBody.quaternion.inverse(),u=d.vmult(l);n.jointBody.position.set(o,i,r),n.mouseConstraint=new a.PointToPointConstraint(n.constrainedBody,u,n.jointBody,new a.Vec3(0,0,0)),x.world.addConstraint(n.mouseConstraint);var m=new e(o,i,r);S.constant=m.dot(c),S.normal.setVector(c)}function l(e,t,n){t.jointBody.position.set(n.x,n.y,n.z),t.mouseConstraint.update()}function d(e,t){x.world.removeConstraint(t.mouseConstraint),t.mouseConstraint=!1}var u,m,p,h,f,y,g,v,w,x,S=new i;return{setup:n,update:r,cleanup:s}}var a=window.CANNON;return r.externals={key:"CannonPickScript",name:"Cannon.js Body Pick",description:"Enables the user to physically pick a Cannon.js physics body and drag it around.",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"pickButton",name:"Pan button",description:"Pick with this button",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"useForceNormal",name:"Use force normal",type:"boolean","default":!1},{key:"forceNormal",name:"Force normal","default":[0,0,1],type:"vec3"}]},r}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.Plane),goo.WASDControlScript=function(e,t,n){function o(){function t(){y.x=p.strafeLeft-p.strafeRight,y.z=p.forward-p.back}function o(e){if(!e.altKey)switch(n.keyForCode(e.keyCode)){case m.crawlKey:p.speed=m.crawlSpeed;break;case m.forwardKey:p.forward=1,t();break;case m.backKey:p.back=1,t();break;case m.strafeLeftKey:p.strafeLeft=1,t();break;case m.strafeRightKey:p.strafeRight=1,t()}}function i(e){if(!e.altKey)switch(n.keyForCode(e.keyCode)){case m.crawlKey:p.speed=m.walkSpeed;break;case m.forwardKey:p.forward=0,t();break;case m.backKey:p.back=0,t();break;case m.strafeLeftKey:p.strafeLeft=0,t();break;case m.strafeRightKey:p.strafeRight=0,t()}}function r(e){e.setAttribute("tabindex",-1),e.addEventListener("keydown",o,!1),e.addEventListener("keyup",i,!1)}function a(e,t){m=e,t.moveState=p={strafeLeft:0,strafeRight:0,forward:0,back:0,crawling:!1,speed:e.walkSpeed},l=t.entity,d=l.transformComponent,u=d.transform,r(t.domElement)}function s(t,n){if(!(y.equals(e.ZERO)||t.whenUsed&&n.entity!==n.activeCameraEntity)){g.set(h.x*y.z+f.x*y.x,h.y*y.z+f.y*y.x,h.z*y.z+f.z*y.x),g.normalize();var o=n.world.tpf*p.speed;g.mul(o);var i=u.rotation;i.applyPost(g),u.translation.add(g),d.setUpdated()}}function c(e,t){t.domElement.removeEventListener("keydown",o,!1),t.domElement.removeEventListener("keyup",i,!1)}var l,d,u,m,p,h=new e(0,0,-1),f=new e(-1,0,0),y=new e,g=new e;return{setup:a,update:s,cleanup:c}}return o.externals={key:"WASD",name:"WASD Control",description:"Enables moving via the WASD keys",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"crawlKey",type:"string",control:"key","default":"Shift"},{key:"forwardKey",type:"string",control:"key","default":"W"},{key:"backKey",type:"string",control:"key","default":"S"},{key:"strafeLeftKey",type:"string",control:"key","default":"A"},{key:"strafeRightKey",type:"string",control:"key","default":"D"},{key:"walkSpeed",type:"int",control:"slider","default":10,min:1,max:100,exponential:!0},{key:"crawlSpeed",control:"slider",type:"int","default":1,min:.1,max:10,exponential:!0}]},o}(goo.Vector3,goo.Scripts,goo.ScriptUtils),goo.MouseLookControlScript=function(e,t,n,o){function i(){function e(e){h.whenUsed&&p.entity!==p.activeCameraEntity||(-1===m||e.button===m)&&(y=!0,g=w=e.clientX,v=x=e.clientY)}function i(){document.pointerLockElement||o.requestPointerLock()}function r(e){(!h.whenUsed||p.entity===p.activeCameraEntity)&&y&&(void 0!==e.movementX?(w+=e.movementX,x+=e.movementY):(w=e.clientX,x=e.clientY))}function a(){y=!1}function s(){y=!!document.pointerLockElement,document.pointerLockElement?p.domElement.removeEventListener("mousedown",i):p.domElement.addEventListener("mousedown",i)}function c(n,c){p=c,h=n,m=["Any","Left","Middle","Right","None"].indexOf(n.button)-1,-1>m&&(m=-1);var l=c.domElement;3===m?(document.addEventListener("pointerlockchange",s),document.addEventListener("mousemove",r),l.addEventListener("mousedown",i),o.requestPointerLock()):(l.addEventListener("mousedown",e),l.addEventListener("mouseup",a),l.addEventListener("mouseleave",a),l.addEventListener("mousemove",r)),u=new t;var d=c.entity.transformComponent.transform.rotation;d.toAngles(u),f=u.data[1]}function l(e,t){if(w!==g||x!==v){var o=w-g,i=x-v,r=t.entity,a=r.transformComponent.transform.rotation;a.toAngles(u);var s=u.data[0],c=u.data[1],l=e.maxAscent*n.DEG_TO_RAD,d=e.minAscent*n.DEG_TO_RAD;s=n.clamp(s-i*e.speed/200,d,l);var m=e.maxAzimuth*n.DEG_TO_RAD-f,p=e.minAzimuth*n.DEG_TO_RAD-f;c-=o*e.speed/200,e.clampAzimuth&&(c=n.radialClamp(c,p,m)),a.fromAngles(s,c,0),r.transformComponent.setUpdated(),g=w,v=x}}function d(t,n){var c=n.domElement;3===m?(o.exitPointerLock(),document.removeEventListener("mousemove",r),c.removeEventListener("mousedown",i),document.removeEventListener("pointerlockchange",s)):(c.removeEventListener("mousemove",r),c.removeEventListener("mousedown",e),c.removeEventListener("mouseup",a),c.removeEventListener("mouseleave",a))}var u,m,p,h,f,y=!1,g=0,v=0,w=0,x=0;return{setup:c,update:l,cleanup:d}}return i.externals={key:"MouseLookScript",name:"Mouse Look Control",description:"Click and drag to change rotation of entity, usually a camera",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"button",name:"Mouse button",type:"string",control:"select","default":"Left",options:["Any","Left","Middle","Right","None"]},{key:"speed",name:"Turn Speed",type:"float",control:"slider","default":1,min:-10,max:10,scale:.1},{key:"maxAscent",name:"Max Ascent",type:"float",control:"slider","default":89.95,min:-89.95,max:89.95},{key:"minAscent",name:"Min Ascent",type:"float",control:"slider","default":-89.95,min:-89.95,max:89.95},{key:"clampAzimuth","default":!1,type:"boolean"},{key:"minAzimuth",description:"Maximum arc the camera can reach clockwise of the target point","default":-90,type:"int",control:"slider",min:-180,max:0},{key:"maxAzimuth",description:"Maximum arc the camera can reach counter-clockwise of the target point","default":90,type:"int",control:"slider",min:0,max:180}]},i}(goo.Scripts,goo.Vector3,goo.MathUtils,goo.GameUtils),goo.FlyControlScript=function(e,t,n){function o(){function o(e,t){s.setup(e,t),a.setup(e,t)}function i(e,t){s.update(e,t),a.update(e,t)}function r(e,t){s.cleanup(e,t),a.cleanup(e,t)}var a=e.create(t),s=e.create(n);return{setup:o,cleanup:r,update:i}}var i=t.externals.parameters,r=n.externals.parameters,a=i.concat(r.slice(1));return o.externals={key:"FlyControlScript",name:"Fly Control",description:"This is a combo of WASDscript and mouselookscript",parameters:a},o}(goo.Scripts,goo.WASDControlScript,goo.MouseLookControlScript),goo.GroundBoundMovementScript=function(e){function t(t){t=t||{};for(var n in o)this[n]="boolean"==typeof o[n]?void 0!==t[n]?t[n]===!0:o[n]:isNaN(o[n])?o[n]instanceof e?t[n]?new e(t[n]):(new e).set(o[n]):t[n]||o[n]:isNaN(t[n])?o[n]:t[n];this.groundContact=1,this.targetVelocity=new e,this.targetHeading=new e,this.acceleration=new e,this.torque=new e,this.groundHeight=0,this.groundNormal=new e,this.controlState={run:0,strafe:0,jump:0,yaw:0,roll:0,pitch:0}}var n=new e,o={gravity:-9.81,worldFloor:-1/0,jumpImpulse:95,accLerp:.1,rotLerp:.1,modForward:1,modStrafe:.7,modBack:.4,modTurn:.3};return t.prototype.setTerrainSystem=function(e){this.terrainScript=e},t.prototype.getTerrainSystem=function(){return this.terrainScript},t.prototype.getTerrainHeight=function(e){var t=this.getTerrainSystem().getTerrainHeightAt(e.data);return null===t&&(t=this.worldFloor),t},t.prototype.getTerrainNormal=function(e){return this.getTerrainSystem().getTerrainNormalAt(e.data)},t.prototype.applyForward=function(e){this.controlState.run=e},t.prototype.applyStrafe=function(e){this.controlState.strafe=e},t.prototype.applyJump=function(e){this.controlState.jump=e},t.prototype.applyTurn=function(e){this.controlState.yaw=e},t.prototype.applyJumpImpulse=function(e){return this.groundContact&&(this.controlState.jump?(e=this.jumpImpulse,this.controlState.jump=0):e=0),e},t.prototype.applyDirectionalModulation=function(e,t,n){e*=this.modStrafe,n*=n>0?this.modForward:this.modBack,this.targetVelocity.set(e,this.applyJumpImpulse(t),n)},t.prototype.applyTorqueModulation=function(e,t,n){this.targetHeading.set(e,t*this.modTurn,n)},t.prototype.applyGroundNormalInfluence=function(){var e=Math.abs(Math.cos(this.groundNormal.data[0])),t=Math.abs(Math.cos(this.groundNormal.data[2]));this.targetVelocity.data[0]*=e,this.targetVelocity.data[2]*=t},t.prototype.updateTargetVectors=function(e){this.applyDirectionalModulation(this.controlState.strafe,this.gravity,this.controlState.run),e.rotation.applyPost(this.targetVelocity),this.applyGroundNormalInfluence(),this.applyTorqueModulation(this.controlState.pitch,this.controlState.yaw,this.controlState.roll)},t.prototype.computeAcceleration=function(e,t,o){return n.set(o),e.transformComponent.transform.rotation.applyPost(n),n.sub(t),n.lerp(o,this.accLerp),n.data[1]=o.data[1],n},t.prototype.computeTorque=function(e,t){return n.set(t),n.sub(e),n.lerp(t,this.rotLerp),n},t.prototype.updateVelocities=function(e){var t=e.movementComponent.getVelocity(),n=e.movementComponent.getRotationVelocity();this.acceleration.set(this.computeAcceleration(e,t,this.targetVelocity)),this.torque.set(this.computeTorque(n,this.targetHeading))},t.prototype.applyAccelerations=function(e){e.movementComponent.addVelocity(this.acceleration),e.movementComponent.addRotationVelocity(this.torque)},t.prototype.updateGroundNormal=function(e){this.groundNormal.set(this.getTerrainNormal(e.translation))},t.prototype.checkGroundContact=function(e,t){this.groundHeight=this.getTerrainHeight(t.translation),t.translation.data[1]<=this.groundHeight?(this.groundContact=1,this.updateGroundNormal(t)):this.groundContact=0},t.prototype.applyGroundContact=function(e,t){this.groundHeight>=t.translation.data[1]&&(t.translation.data[1]=this.groundHeight,e.movementComponent.velocity.data[1]<0&&(e.movementComponent.velocity.data[1]=0))},t.prototype.run=function(e){var t=e.transformComponent.transform;this.checkGroundContact(e,t),this.updateTargetVectors(t),this.updateVelocities(e),this.applyAccelerations(e),this.applyGroundContact(e,t)},t}(goo.Vector3),goo.HeightMapBoundingScript=function(e){function t(e){this.matrixData=e,this.width=e.length-1}return t.prototype.getMatrixData=function(){return this.matrixData},t.prototype.getPointInMatrix=function(e,t){return this.matrixData[e][t]},t.prototype.getAt=function(e,t){return 0>e||e>this.width||0>t||t>this.width?0:this.getPointInMatrix(e,t)},t.prototype.getInterpolated=function(e,t){var n=this.getAt(Math.ceil(e),Math.ceil(t)),o=this.getAt(Math.ceil(e),Math.floor(t)),i=this.getAt(Math.floor(e),Math.ceil(t)),r=this.getAt(Math.floor(e),Math.floor(t)),a=e-Math.floor(e),s=t-Math.floor(t),c=n*a+i*(1-a),l=o*a+r*(1-a),d=c*s+l*(1-s);return d},t.prototype.getTriangleAt=function(e,t){var n,o=Math.ceil(e),i=Math.floor(e),r=Math.ceil(t),a=Math.floor(t),s=e-i,c=t-a,l={x:i,y:r,z:this.getAt(i,r)},d={x:o,y:a,z:this.getAt(o,a)};return n=1-c>s?{x:i,y:a,z:this.getAt(i,a)}:{x:o,y:r,z:this.getAt(o,r)},[l,d,n]},t.prototype.getPreciseHeight=function(t,n){var o=this.getTriangleAt(t,n),i=e.barycentricInterpolation(o[0],o[1],o[2],{x:t,y:n,z:0});return i.z},t.prototype.run=function(e){var t=e.transformComponent.transform.translation;t.data[1]=this.getInterpolated(t.data[2],t.data[0])},t}(goo.MathUtils),goo.LensFlareScript=function(e,t,n,o,i){function r(){function e(e){v.size=e,v.splash=t.createSplashTexture(512,{trailStartRadius:25,trailEndRadius:0}),v.ring=t.createFlareTexture(e,{steps:w.ring,startRadius:e/4,endRadius:e/2}),v.dot=t.createFlareTexture(e,{steps:w.dot,startRadius:0,endRadius:e/2}),v.bell=t.createFlareTexture(e,{steps:w.bell,startRadius:0,endRadius:e/2}),v["default"]=t.createFlareTexture(e,{steps:w.none,startRadius:0,endRadius:e/2})}function n(e,t,n,o,i){for(var r=0;r<e.length;r++){var a=e[r];y.push(new s(t,a.tx,a.displace,a.size,a.intensity*h,n,o,i,v,d))}return y}function o(e){for(var t=0;t<e.length;t++)e[t].quad.removeFromWorld()}function i(t,n){h=t.intensity,f=new a(100*t.edgeRelevance);var o=g;t.highRes&&(o*=4),v.size!==o&&e(o),y=[],l=n.entity,d=n.world,u=!1,p=[t.color[0],t.color[1],t.color[2],1],m=[{size:2.53,tx:"bell",intensity:.7,displace:1},{size:.53,tx:"dot",intensity:.7,displace:1},{size:.83,tx:"bell",intensity:.2,displace:.8},{size:.4,tx:"ring",intensity:.1,displace:.6},{size:.3,tx:"bell",intensity:.1,displace:.4},{size:.6,tx:"bell",intensity:.1,displace:.3},{size:.3,tx:"dot",intensity:.1,displace:.15},{size:.22,tx:"ring",intensity:.03,displace:-.25},{size:.36,tx:"dot",intensity:.05,displace:-.5},{size:.8,tx:"ring",intensity:.1,displace:-.8},{size:.86,tx:"bell",intensity:.2,displace:-1.1},{size:1.3,tx:"ring",intensity:.05,displace:-1.5}]}function r(){o(y),y=[]}function c(e,t){if(t.entity.isVisible!==!1){f.updateFrameGeometry(l,t.activeCameraEntity),u||(y=n(m,p,e.scale,e.edgeDampen,e.edgeScaling),u=!0);for(var i=0;i<y.length;i++)y[i].updatePosition(f)}else u&&(o(y),u=!1)}var l,d,u,m,p,h,f,y=[],g=64,v={},w={splash:{trailStartRadius:25,trailEndRadius:0},ring:[{fraction:0,value:0},{fraction:.7,value:0},{fraction:.92,value:1},{fraction:.98,value:0}],dot:[{fraction:0,value:1},{fraction:.3,value:.75},{fraction:.5,value:.45},{fraction:.65,value:.21},{fraction:.75,value:.1},{fraction:.98,value:0}],bell:[{fraction:0,value:1},{fraction:.15,value:.75},{fraction:.3,value:.5},{fraction:.4,value:.25},{fraction:.75,value:.05},{fraction:.98,value:0}],none:[{fraction:0,value:1},{fraction:1,value:0}]};return{setup:i,update:c,cleanup:r}}function a(t){this.camRot=null,this.distance=0,this.offset=0,this.centerRatio=0,this.positionVector=new e,this.distanceVector=new e,this.centerVector=new e,this.displacementVector=new e,this.edgeRelevance=t}function s(t,r,a,s,c,l,d,u,m,p){this.sizeVector=new e(s,s,s),this.sizeVector.mul(l),this.positionVector=new e,this.flareVector=new e,this.intensity=c,this.displace=a,this.color=[t[0]*c,t[1]*c,t[2]*c,1],this.edgeDampen=d,this.edgeScaling=u;var h=new n(o.uber,"flareShader");h.uniforms.materialEmissive=this.color,h.uniforms.materialDiffuse=[0,0,0,1],h.uniforms.materialAmbient=[0,0,0,1],h.uniforms.materialSpecular=[0,0,0,1];var f=m[r];h.setTexture("DIFFUSE_MAP",f),h.setTexture("EMISSIVE_MAP",f),h.blendState.blending="AdditiveBlending",h.blendState.blendEquation="AddEquation",h.blendState.blendSrc="OneFactor",h.blendState.blendDst="OneFactor",h.depthState.enabled=!1,h.depthState.write=!1,h.cullState.enabled=!1;var y=new i(1,1),g=p.createEntity(y,h);g.meshRendererComponent.cullMode="Never",g.addToWorld(),this.material=h,this.quad=g}return r.externals={key:"LensFlareScript",name:"Lens Flare Script",description:"Makes an entity shine with some lensflare effect.",parameters:[{key:"scale",name:"Scale",type:"float",description:"Scale of flare quads",control:"slider","default":1,min:.01,max:2},{key:"intensity",name:"Intensity",type:"float",description:"Intensity of Effect",control:"slider","default":1,min:.01,max:2},{key:"edgeRelevance",name:"Edge Relevance",type:"float",description:"How much the effect cares about being centered or not",control:"slider","default":0,min:0,max:2},{key:"edgeDampen",name:"Edge Dampening",type:"float",description:"Intensity adjustment by distance from center",control:"slider","default":.2,min:0,max:1},{key:"edgeScaling",name:"Edge Scaling",type:"float",description:"Scale adjustment by distance from center",control:"slider","default":0,min:-2,max:2},{key:"color",name:"Color",type:"vec3",description:"Effect Color",control:"color","default":[.8,.75,.7]},{key:"highRes",name:"High Resolution",type:"boolean",description:"Intensity of Effect",control:"checkbox","default":!1}]},a.prototype.updateFrameGeometry=function(e,t){this.camRot=t.transformComponent.transform.rotation,this.centerVector.set(t.cameraComponent.camera.translation),this.displacementVector.set(e.transformComponent.worldTransform.translation),this.displacementVector.sub(this.centerVector),this.distance=this.displacementVector.length(),this.distanceVector.set(0,0,-this.distance),this.camRot.applyPost(this.distanceVector),this.centerVector.add(this.distanceVector),this.positionVector.set(this.centerVector),this.displacementVector.set(e.transformComponent.worldTransform.translation),this.displacementVector.sub(this.positionVector),this.offset=this.displacementVector.length();var n=this.positionVector.length();this.centerRatio=n?1-this.offset*this.edgeRelevance/this.positionVector.length():1-this.offset*this.edgeRelevance,this.centerRatio=Math.max(0,this.centerRatio)},s.prototype.updatePosition=function(e){this.flareVector.set(e.displacementVector),this.positionVector.set(e.positionVector),this.flareVector.mul(this.displace),this.positionVector.add(this.flareVector),this.material.uniforms.materialEmissive=[this.color[0]*e.centerRatio*this.edgeDampen,this.color[1]*e.centerRatio*this.edgeDampen,this.color[2]*e.centerRatio*this.edgeDampen,1];var t=e.distance+e.distance*e.centerRatio*this.edgeScaling,n=this.quad.transformComponent.transform;n.scale.set(this.sizeVector),n.scale.mul(t),n.rotation.set(e.camRot),n.translation.set(this.positionVector),this.quad.transformComponent.updateTransform(),this.quad.transformComponent.updateWorldTransform()},r}(goo.Vector3,goo.ParticleSystemUtils,goo.Material,goo.ShaderLib,goo.Quad),goo.PanCamScript=function(e,t,n,o,i,r){function a(){function t(e){var t=e[0].clientX,n=e[0].clientY,o=e[1].clientX,i=e[1].clientY,r=(t+o)/2,a=(n+i)/2;return[r,a]}function n(n,o){p=["Any","Left","Middle","Right"].indexOf(n.panButton)-1,-1>p&&(p=-1),h=o.goingToLookAt,c=new e(e.UNIT_Y),l=new e(e.UNIT_X).invert(),d=new e,u=new e,m=new e;var i=o.world.gooRunner.renderer;o.devicePixelRatio=i._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/i.svg.currentScale:1,f={x:0,y:0,ox:0,oy:0,dx:0,dy:0,down:!1},y={mousedown:function(e){if(!n.whenUsed||o.entity===o.activeCameraEntity){var t=e.button;if(0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),t===p||-1===p){f.down=!0;var i=void 0!==e.offsetX?e.offsetX:e.layerX,r=void 0!==e.offsetY?e.offsetY:e.layerY;f.ox=f.x=i,f.oy=f.y=r}}},mouseup:function(e){var t=e.button;0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),f.down=!1,f.dx=f.dy=0},mousemove:function(e){if((!n.whenUsed||o.entity===o.activeCameraEntity)&&f.down){var t=void 0!==e.offsetX?e.offsetX:e.layerX,i=void 0!==e.offsetY?e.offsetY:e.layerY;f.x=t,f.y=i,o.dirty=!0}},mouseleave:function(){f.down=!1,f.ox=f.x,f.oy=f.y},touchstart:function(e){if(!n.whenUsed||o.entity===o.activeCameraEntity){if(f.down=2===e.targetTouches.length,!f.down)return;var i=t(e.targetTouches);f.ox=f.x=i[0],f.oy=f.y=i[1]}},touchmove:function(e){if(!n.whenUsed||o.entity===o.activeCameraEntity){if(!f.down)return;var i=t(e.targetTouches);f.x=i[0],f.y=i[1]}},touchend:function(){f.down=!1,f.ox=f.x,f.oy=f.y}};for(var r in y)o.domElement.addEventListener(r,y[r]);o.dirty=!0}function a(e,t){if(t.dirty){if(f.dx=f.x-f.ox,f.dy=f.y-f.oy,0===f.dx&&0===f.dy)return void(t.dirty=!!t.lookAtPoint);e.invertX&&(f.dx=-f.dx),e.invertY&&(f.dy=-f.dy),f.ox=f.x,f.oy=f.y;
var n=o.mainCamera,a=t.entity,s=a.transformComponent.transform,d=a.cameraComponent.camera;if(h&&n){if(h.equals(n.translation))return;var p=t.viewportWidth/t.devicePixelRatio,y=t.viewportHeight/t.devicePixelRatio;n.getScreenCoordinates(h,p,y,u),u.subDirect(f.dx,f.dy,0),n.getWorldCoordinates(u.x,u.y,p,y,u.z,u),h.setVector(u)}else{if(u.setVector(c).scale(f.dy),m.setVector(l).scale(f.dx),a.cameraComponent&&a.cameraComponent.camera){var d=a.cameraComponent.camera;u.scale((d._frustumTop-d._frustumBottom)/t.viewportHeight),m.scale((d._frustumRight-d._frustumLeft)/t.viewportWidth)}u.addVector(m),s.rotation.applyPost(u),u.scale(d.projectionMode===r.Perspective?20*e.panSpeed:e.panSpeed),a.transformComponent.transform.translation.addVector(u),a.transformComponent.setUpdated(),t.dirty=!1}i.emit("goo.cameraPositionChanged",{translation:s.translation.data,lookAtPoint:h?h.data:null,id:a.id})}}function s(e,t){for(var n in y)t.domElement.removeEventListener(n,y[n])}var c,l,d,u,m,p,h,f,y;return{setup:n,update:a,cleanup:s}}return a.externals={key:"PanCamControlScript",name:"PanCamera Control",description:"Enables camera to pan around a point in 3D space using the mouse",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"panButton",name:"Pan button",description:"Only pan with this button",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"panSpeed",type:"float","default":1,scale:.01}]},a}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.SystemBus,goo.Camera),goo.OrbitNPanControlScript=function(e,t,n,o){function i(){function o(e,t,n){a.setup(e,t,n),s.setup(e,t,n)}function i(e,t,n){s.update(e,t,n),a.update(e,t,n)}function r(e,t,n){s.cleanup(e,t,n),a.cleanup(e,t,n)}var a=e.create(t),s=e.create(n);return{setup:o,cleanup:r,update:i}}for(var r=t.externals.parameters,a=n.externals.parameters,s=o.deepClone(r.concat(a.slice(1))),c=0;c<s.length;c++){var l=s[c];if("panSpeed"===l.key){s.splice(c,1);break}}for(var c=0;c<s.length;c++){var l=s[c];switch(l.key){case"dragButton":l["default"]="Left";break;case"panButton":l["default"]="Right";break;case"panSpeed":l["default"]=1}}return i.externals={key:"OrbitNPanControlScript",name:"Orbit and Pan Control",description:"This is a combo of orbitcamcontrolscript and pancamcontrolscript",parameters:s},i}(goo.Scripts,goo.OrbitCamControlScript,goo.PanCamScript,goo.ObjectUtil),goo.PickAndRotateScript=function(){function e(){function e(e){var t=e.button;return 0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),t}function t(t){if(!d.disable){var o=e(t.domEvent);(o===u.dragButton||-1===u.dragButton)&&t.entity&&(l=!1,t.entity.traverseUp(function(e){return e===u.entity?(l=!0,!1):void 0}),l&&n(t))}}function n(e){m.x=e.x,m.y=e.y,m.oldX=m.x,m.oldY=m.y,m.down=!0}function o(e){if(m.oldX=m.x,m.oldY=m.y,m.x=e.clientX||e.touches[0].clientX,m.y=e.clientY||e.touches[0].clientY,l&&m.down){var t=m.x-m.oldX,n=m.y-m.oldY;m.ax+=t,m.ay+=n,u.entity.transformComponent.transform.rotation.setIdentity(),u.entity.transformComponent.transform.rotation.rotateX(m.ay/300*d.yMultiplier),u.entity.transformComponent.transform.rotation.rotateY(m.ax/200*d.xMultiplier),u.entity.transformComponent.setUpdated()}}function i(){m.down=!1}function r(e,n){d=e,u=n,u.dragButton=["Any","Left","Middle","Right"].indexOf(d.dragButton)-1,u.dragButton<-1&&(u.dragButton=-1),c=u.world.gooRunner,c.addEventListener("mousedown",t),c.addEventListener("touchstart",t),c.renderer.domElement.addEventListener("mousemove",o),c.renderer.domElement.addEventListener("touchmove",o),c.renderer.domElement.addEventListener("mouseup",i),c.renderer.domElement.addEventListener("touchend",i),m={down:!1,x:0,y:0,oldX:0,oldY:0,ax:0,ay:0}}function a(){}function s(e,n){n.domElement.removeEventListener("mousemove",o),n.domElement.removeEventListener("touchmove",o),n.domElement.removeEventListener("mouseup",i),n.domElement.removeEventListener("touchend",i),c.removeEventListener("mousedown",t),c.removeEventListener("touchstart",t)}var c,l,d,u,m;return{setup:r,update:a,cleanup:s}}return e.externals={key:"PickAndRotateScript",name:"Pick and Rotate",description:"Enables pick-drag-rotating entities",parameters:[{key:"disable",description:"Prevent rotation. For preventing this script programmatically.",type:"boolean","default":!1},{key:"dragButton",description:"Button to enable dragging","default":"Any",options:["Any","Left","Middle","Right"],type:"string",control:"select"},{key:"xMultiplier",description:"Horizontal rotation multiplier","default":1,type:"float",control:"slider",min:-4,max:4},{key:"yMultiplier",description:"Vertical rotation multiplier","default":1,type:"float",control:"slider",min:-4,max:4}]},e}(),goo.PolyBoundingScript=function(){function e(e){this.collidables=e||[]}return e.prototype.addCollidable=function(e){this.collidables.push(e)},e.prototype.removeAllAt=function(e,t,n){this.collidables=this.collidables.filter(function(o){return o.bottom<=n&&o.top>=n?!window.PolyK.ContainsPoint(o.poly,e,t):void 0})},e.prototype.inside=function(e,t,n){for(var o=0;o<this.collidables.length;o++){var i=this.collidables[o];if(i.bottom<=t&&i.top>=t&&window.PolyK.ContainsPoint(i.poly,e,n))return window.PolyK.ClosestEdge(i.poly,e,n)}},e.prototype.run=function(e){for(var t=e.transformComponent,n=t.transform.translation,o=0;o<this.collidables.length;o++){var i=this.collidables[o];if(i.bottom<=n.data[1]&&i.top>=n.data[1]&&window.PolyK.ContainsPoint(i.poly,n.data[0],n.data[2])){var r=window.PolyK.ClosestEdge(i.poly,n.data[0],n.data[2]);return n.data[0]=r.point.x,n.data[2]=r.point.y,t.setUpdated(),void 0}}},e}(),goo.RotationScript=function(){function e(){function e(e,t){i={x:0,y:0},r={x:0,y:0},a=t.entity,document.addEventListener("mousemove",n)}function t(e){r.x+=(i.x-r.x)*e.fraction,r.y+=(i.y-r.y)*e.fraction,a.setRotation(r.y/200,r.x/200,0)}function n(e){i.x=e.x,i.y=e.y}function o(){document.removeEventListener("mousemove",n)}var i,r,a;return{setup:e,update:t,cleanup:o}}return e.externals={key:"RotationScript",name:"Mouse Rotation",description:"",parameters:[{key:"fraction",name:"Speed","default":.01,type:"float",control:"slider",min:.01,max:1}]},e}(),goo.ScriptComponentHandler=function(e,t,n,o,i,r,a,s){function c(){e.apply(this,arguments),this._type="ScriptComponent"}function l(e){var t=a.create(e);if(!t)throw new Error("Unrecognized script name");return t.id=c.ENGINE_SCRIPT_PREFIX+e,t.enabled=!1,r.emit("goo.scriptExternals",{id:t.id,externals:t.externals}),i.resolve(t)}return c.prototype=Object.create(e.prototype),c.prototype.constructor=c,e._registerClass("script",c),c.ENGINE_SCRIPT_PREFIX="GOO_ENGINE_SCRIPTS/",c.prototype._prepare=function(){},c.prototype._create=function(){return new t},c.prototype.update=function(t,i,r){var a=this;return e.prototype.update.call(this,t,i,r).then(function(e){if(e){var t=[];return o.forEach(i.scripts,function(e){var n=e.scriptRef,i=0===n.indexOf(c.ENGINE_SCRIPT_PREFIX),d=null;if(i){var u=n.slice(c.ENGINE_SCRIPT_PREFIX.length);d=l(u)}else d=a._load(e.scriptRef,{reload:!0});d=d.then(function(t){e.options=e.options||{},t.parameters&&o.defaults(e.options,t.parameters),t.externals&&t.externals.parameters&&s.fillDefaultValues(e.options,t.externals.parameters);var n=Object.create(t);return n.parameters={},n.enabled=!1,a._setParameters(n.parameters,e.options,t.externals,r).then(function(){return n})}),t.push(d)},null,"sortValue"),n.all(t).then(function(t){return e.scripts=t,e})}})},c.prototype._setParameters=function(e,t,o,r){if(!o||!o.parameters)return i.resolve();for(var a=[],s=0;s<o.parameters.length;s++){var c=o.parameters[s];this._setParameter(e,t[c.key],c,r)}return e.enabled=void 0!==t.enabled?t.enabled:!0,n.all(a)},c.prototype._setParameter=function(e,t,n,r){var a=n.key;return"texture"===n.type?t&&t.textureRef&&t.enabled!==!1?this._load(t.textureRef,r).then(function(t){e[a]=t}):(e[a]=null,i.resolve()):"entity"===n.type?t&&t.entityRef&&t.enabled!==!1?this._load(t.entityRef,r).then(function(t){e[a]=t}):(e[a]=null,i.resolve()):(e[a]=o.extend(t),i.resolve())},c}(goo.ComponentHandler,goo.ScriptComponent,goo.rsvp,goo.ObjectUtil,goo.PromiseUtil,goo.SystemBus,goo.Scripts,goo.ScriptUtils),goo.ScriptHandler=function(e,t,n,o,i,r,a,s,c,l,d,u,m){function p(){e.apply(this,arguments),this._bodyCache={},this._dependencyPromises={},this._currentScriptLoading=null,this._addGlobalErrorListener()}function h(){for(var e=document.querySelectorAll("script"),t=0;t<e.length;++t){var n=e[t];n.isDependency&&!g(n)&&n.parentNode&&n.parentNode.removeChild(n)}}function f(e,t){if(!e.scriptRefs)return void(e.scriptRefs=[t]);var n=e.scriptRefs.indexOf(t);-1===n&&e.scriptRefs.push(t)}function y(e,t){e.scriptRefs&&l.remove(e.scriptRefs,t)}function g(e){return e.scriptRefs&&e.scriptRefs.length>0}function v(e,t){return e.scriptRefs&&e.scriptRefs.indexOf(t)>-1}function w(e){for(var t=[],n=document.querySelectorAll("script"),o=0;o<n.length;++o){var i=n[o];v(i,e)&&t.push(i)}return t}function x(e,t,n){return s.createPromise(function(o){function i(i){var r={message:i,file:n};b(e,r),t.parentNode&&t.parentNode.removeChild(t),o()}var r,a=!1;t.onload=function(){o(),r&&clearTimeout(r)},t.onerror=function(e){a=!0,r&&clearTimeout(r),console.error(e),i("Could not load dependency "+n)},a||(a=!0,r=setTimeout(function(){i("Loading dependency "+n+" failed (time out).")},k))})}function S(e,t){var n=e.errors||[];if("object"!=typeof e.externals)return void(t.externals={});var o=e.externals;if(o.parameters&&!(o.parameters instanceof Array)&&n.push("externals.parameters needs to be an array"),n.length)return void(t.errors=n);if(o.parameters){t.externals.parameters=[];for(var i=0;i<o.parameters.length;i++){var r=o.parameters[i];if("string"==typeof r.key&&0!==r.key.length)if(void 0===r.name||"string"==typeof r.name&&0!==r.name.length)if(-1!==E.indexOf(r.type))if(void 0===r.control||"string"==typeof r.control&&0!==r.control.length){var a=C[r.type];void 0===r.control||-1!==a.indexOf(r.control)?void 0===r.options||r.options instanceof Array?void 0===r.min||"number"==typeof r.min?void 0===r.max||"number"==typeof r.max?void 0===r.scale||"number"==typeof r.scale?void 0===r.decimals||"number"==typeof r.decimals?void 0===r.precision||"number"==typeof r.precision?void 0===r.exponential||"boolean"==typeof r.exponential?((null===r["default"]||void 0===r["default"])&&(r["default"]=u.defaultsByType[r.type]),t.externals.parameters.push(r)):n.push({message:'Parameter "exponential" needs to be a boolean.'}):n.push({message:'Parameter "precision" needs to be a number.'}):n.push({message:'Parameter "decimals" needs to be a number.'}):n.push({message:'Parameter "scale" needs to be a number.'}):n.push({message:'Parameter "max" needs to be a number.'}):n.push({message:'Parameter "min" needs to be a number.'}):n.push({message:'Parameter "key" needs to be array'}):n.push({message:'Parameter "control" needs to be one of: '+a.join(", ")+"."})}else n.push({message:'Parameter "control" needs to be a non-empty string.'});else n.push({message:'Parameter "type" needs to be one of: '+E.join(", ")+"."});else n.push({message:'Parameter "name" needs to be a non-empty string.'});else n.push({message:'Parameter "key" needs to be a non-empty string.'})}n.length&&(t.errors=n)}}function b(e,t){if(t.file){var n=t.message;t.line&&(n+=" - on line "+t.line),e.dependencyErrors=e.dependencyErrors||{},e.dependencyErrors[t.file]=t}else{e.errors=e.errors||[];var n=t.message;t.line&&(n+=" - on line "+t.line),e.errors.push(t),e.setup=null,e.update=null,e.run=null,e.cleanup=null,e.parameters={},e.enabled=!1}}var k=6e3;p.prototype=Object.create(e.prototype),p.prototype.constructor=p,e._registerClass("script",p),p.prototype._create=function(){return{externals:{},setup:null,update:null,run:null,cleanup:null,parameters:{},name:null}},p.prototype._remove=function(e){var t=this._objects.get(e);if(t&&t.cleanup&&t.context)try{t.cleanup(t.parameters,t.context,m.getClasses())}catch(n){}this._objects["delete"](e),delete this._bodyCache[e]},p.prototype._updateFromCustom=function(e,t){if(this._bodyCache[t.id]===t.body)return e;delete e.errors,this._bodyCache[t.id]=t.body;var n=document.getElementById(p.DOM_ID_PREFIX+t.id);n&&n.parentNode.removeChild(n),window._gooScriptFactories||(window._gooScriptFactories={});var o=["window._gooScriptFactories['"+t.id+"'] = function () {",t.body," var obj = {","  externals: {}"," };",' if (typeof parameters !== "undefined") {',"  obj.externals.parameters = parameters;"," }",' if (typeof setup !== "undefined") {',"  obj.setup = setup;"," }",' if (typeof cleanup !== "undefined") {',"  obj.cleanup = cleanup;"," }",' if (typeof update !== "undefined") {',"  obj.update = update;"," }"," return obj;","};"].join("\n"),i=document.createElement("script");i.id=p.DOM_ID_PREFIX+t.id,i.innerHTML=o,i.async=!1,this._currentScriptLoading=t.id;var r=this.world.gooRunner.renderer.domElement.parentElement||document.body;r.appendChild(i);var a=window._gooScriptFactories[t.id];if(a){try{a=a(),e.id=t.id,S(a,e),e.setup=a.setup,e.update=a.update,e.cleanup=a.cleanup,e.parameters={},e.enabled=!1}catch(s){var c={message:s.toString()};if(s instanceof Error){var l=s.stack.split("\n")[1].match(/(\d+):\d+\)$/);l&&(c.line=parseInt(l[1],10)-1)}b(e,c)}this._currentScriptLoading=null}return e.externals&&u.fillDefaultNames(e.externals.parameters),e},p.prototype._updateFromClass=function(e,t){if(!e.externals||e.externals.name!==t.className){var n=m.create(t.className);if(!n)throw new Error("Unrecognized script name");e.id=t.id,e.externals=n.externals,e.setup=n.setup,e.update=n.update,e.run=n.run,e.cleanup=n.cleanup,e.parameters=n.parameters||{},e.enabled=!1,u.fillDefaultNames(e.externals.parameters)}return e},p.prototype._update=function(n,o,i){var r=this;return e.prototype._update.call(this,n,o,i).then(function(e){if(e){var a=[];if(o.body&&o.dependencies){delete e.dependencyErrors;var s=w(o.id);c.forEach(o.dependencies,function(t){var n=t.url,i=l.find(s,function(e){return e.src===n});i&&l.remove(s,i),a.push(r._addDependency(e,n,o.id))},null,"sortValue"),c.forEach(s,function(e){y(e,o.id)})}return t.all(a).then(function(){return o.className?r._updateFromClass(e,o,i):o.body&&r._updateFromCustom(e,o,i),o.body&&d.emit("goo.scriptExternals",{id:o.id,externals:e.externals}),e.name=o.name,e.errors||e.dependencyErrors?(d.emit("goo.scriptError",{id:n,errors:e.errors,dependencyErrors:e.dependencyErrors}),e):(d.emit("goo.scriptError",{id:n,errors:null}),c.extend(e.parameters,o.options),h(),e)})}})},p.prototype._addDependency=function(e,t,n){var o=this,i=document.querySelector('script[src="'+t+'"]');if(i)return f(i,n),this._dependencyPromises[t]||s.resolve();i=document.createElement("script"),i.src=t,i.setAttribute("data-script-id",n),i.isDependency=!0,f(i,n);var r=this.world.gooRunner.renderer.domElement.parentElement||document.body;r.appendChild(i);var a=this._dependencyPromises[t]=x(e,i,t).then(function(){delete o._dependencyPromises[t]});return a},p.prototype._addGlobalErrorListener=function(){var e=this;window.addEventListener("error",function(t){if(t.filename){var n=document.querySelector('script[src="'+t.filename+'"]');if(n){var o=n.getAttribute("data-script-id"),i=e._objects.get(o);if(i){var r={message:t.message,line:t.lineno,file:t.filename};b(i,r)}n.parentNode.removeChild(n)}}if(e._currentScriptLoading){var a=document.getElementById(p.DOM_ID_PREFIX+e._currentScriptLoading);a&&a.parentNode.removeChild(a),delete window._gooScriptFactories[e._currentScriptLoading];var i=e._objects.get(e._currentScriptLoading),r={message:t.message,line:t.lineno-1};b(i,r),e._currentScriptLoading=null}})};var E=["string","int","float","vec2","vec3","vec4","boolean","texture","image","sound","camera","entity","animation"],C={string:["key"],"int":["spinner","slider","jointSelector"],"float":["spinner","slider"],vec2:[],vec3:["color"],vec4:["color"],"boolean":["checkbox"],texture:[],image:[],sound:[],camera:[],entity:[],animation:[]};for(var R in C)Array.prototype.push.apply(C[R],["dropdown","select"]);return p.DOM_ID_PREFIX="_script_",p}(goo.ConfigHandler,goo.rsvp,goo.OrbitCamControlScript,goo.OrbitNPanControlScript,goo.FlyControlScript,goo.WASDControlScript,goo.BasicControlScript,goo.PromiseUtil,goo.ObjectUtil,goo.ArrayUtil,goo.SystemBus,goo.ScriptUtils,goo.Scripts),goo.ScriptHandlers=function(){}(goo.ScriptHandler,goo.ScriptComponentHandler),goo.ScriptRegister=function(e){for(var t=1;t<arguments.length;t++)e.register(arguments[t]),e.addClass(arguments[t].name,arguments[t])}(goo.Scripts,goo.OrbitCamControlScript,goo.OrbitNPanControlScript,goo.FlyControlScript,goo.AxisAlignedCamControlScript,goo.PanCamScript,goo.MouseLookControlScript,goo.WASDControlScript,goo.ButtonScript,goo.PickAndRotateScript,goo.LensFlareScript),goo.SparseHeightMapBoundingScript=function(){function e(e){this.elevationData=e}return e.prototype.getClosest=function(e,t){for(var n=Number.MAX_VALUE,o=-1,i=0;i<this.elevationData.length;i+=3){var r=Math.pow(this.elevationData[i+0]-e,2)+Math.pow(this.elevationData[i+2]-t,2);n>r&&(n=r,o=i)}return this.elevationData[o+1]},e.prototype.run=function(e){var t=e.transformComponent.transform.translation,n=this.getClosest(t.data[0],t.data[2]),o=t.data[1]-n;t.data[1]-=.1*o},e}(),goo.WorldFittedTerrainScript=function(e,t){function n(e,t){if(e.minX>e.maxX)throw{name:"Terrain Exception",message:"minX is larger than maxX"};if(e.minY>e.maxY)throw{name:"Terrain Exception",message:"minY is larger than maxY"};if(e.minZ>e.maxZ)throw{name:"Terrain Exception",message:"minZ is larger than maxZ"};if(!t)throw{name:"Terrain Exception",message:"No heightmap data specified"};if(t.length!==t[0].length)throw{name:"Terrain Exception",message:"Heightmap data is not a square"};return!0}function o(t,o,i){o=o||s,n(o,t,i);var r={dimensions:o,sideQuadCount:t.length-1,script:new e(t)};return r}function i(){this.heightMapData=[],this.yMargin=1}var r=new t,a=new t,s={minX:0,maxX:100,minY:0,maxY:50,minZ:0,maxZ:100};return i.prototype.addHeightData=function(e,t){var n=o(e,t,this.heightMapData);return this.heightMapData.push(n),n},i.prototype.getHeightDataForPosition=function(e){for(var t=0;t<this.heightMapData.length;t++){var n=this.heightMapData[t].dimensions;if(e[0]<=n.maxX&&e[0]>=n.minX&&e[1]<n.maxY+this.yMargin&&e[1]>n.minY-this.yMargin&&e[2]<=n.maxZ&&e[2]>=n.minZ)return this.heightMapData[t]}return null},i.prototype.displaceAxisDimensions=function(e,t,n,o){var i=e-t;return o*i/(n-t)},i.prototype.returnToWorldDimensions=function(e,t,n,o){var i=(n-t)/o,r=e*i;return t+r},i.prototype.getTerrainHeightAt=function(e){var t=this.getHeightDataForPosition(e);if(null===t)return null;var n=t.dimensions,o=this.displaceAxisDimensions(e[0],n.minX,n.maxX,t.sideQuadCount),i=this.displaceAxisDimensions(e[2],n.minZ,n.maxZ,t.sideQuadCount),r=t.script.getPreciseHeight(o,i);return r*(n.maxY-n.minY)+n.minY},i.prototype.getTerrainNormalAt=function(e){var t=this.getHeightDataForPosition(e);if(!t)return null;for(var n=t.dimensions,o=this.displaceAxisDimensions(e[0],n.minX,n.maxX,t.sideQuadCount),i=this.displaceAxisDimensions(e[2],n.minZ,n.maxZ,t.sideQuadCount),s=t.script.getTriangleAt(o,i),c=0;c<s.length;c++)s[c].x=this.returnToWorldDimensions(s[c].x,n.minX,n.maxX,t.sideQuadCount),s[c].z=this.returnToWorldDimensions(s[c].z,n.minY,n.maxY,1),s[c].y=this.returnToWorldDimensions(s[c].y,n.minZ,n.maxZ,t.sideQuadCount);return r.set(s[1].x-s[0].x,s[1].z-s[0].z,s[1].y-s[0].y),a.set(s[2].x-s[0].x,s[2].z-s[0].z,s[2].y-s[0].y),r.cross(a),r.data[1]<0&&r.scale(-1),r.normalize(),r},i}(goo.HeightMapBoundingScript,goo.Vector3);
(function (define) {
define("goo/scriptpack/AxisAlignedCamControlScript", [], function () { return goo.AxisAlignedCamControlScript; });
define("goo/scriptpack/BasicControlScript", [], function () { return goo.BasicControlScript; });
define("goo/scriptpack/ButtonScript", [], function () { return goo.ButtonScript; });
define("goo/scriptpack/CannonPickScript", [], function () { return goo.CannonPickScript; });
define("goo/scriptpack/WASDControlScript", [], function () { return goo.WASDControlScript; });
define("goo/scriptpack/MouseLookControlScript", [], function () { return goo.MouseLookControlScript; });
define("goo/scriptpack/FlyControlScript", [], function () { return goo.FlyControlScript; });
define("goo/scriptpack/GroundBoundMovementScript", [], function () { return goo.GroundBoundMovementScript; });
define("goo/scriptpack/HeightMapBoundingScript", [], function () { return goo.HeightMapBoundingScript; });
define("goo/scriptpack/LensFlareScript", [], function () { return goo.LensFlareScript; });
define("goo/scriptpack/PanCamScript", [], function () { return goo.PanCamScript; });
define("goo/scriptpack/OrbitNPanControlScript", [], function () { return goo.OrbitNPanControlScript; });
define("goo/scriptpack/PickAndRotateScript", [], function () { return goo.PickAndRotateScript; });
define("goo/scriptpack/PolyBoundingScript", [], function () { return goo.PolyBoundingScript; });
define("goo/scriptpack/RotationScript", [], function () { return goo.RotationScript; });
define("goo/scriptpack/ScriptComponentHandler", [], function () { return goo.ScriptComponentHandler; });
define("goo/scriptpack/ScriptHandler", [], function () { return goo.ScriptHandler; });
define("goo/scriptpack/ScriptHandlers", [], function () { return goo.ScriptHandlers; });
define("goo/scriptpack/ScriptRegister", [], function () { return goo.ScriptRegister; });
define("goo/scriptpack/SparseHeightMapBoundingScript", [], function () { return goo.SparseHeightMapBoundingScript; });
define("goo/scriptpack/WorldFittedTerrainScript", [], function () { return goo.WorldFittedTerrainScript; });
})(goo.useOwnRequire || !window.define ? goo.define : define);
} (goo.useOwnRequire || !window.define ? goo.require : require)(["goo"], f); })();